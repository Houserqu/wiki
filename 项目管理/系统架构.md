# 系统架构

## 架构模式

[系统设计入门](https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md)

### 微服务

[一篇文章快速理解微服务架构](http://dockone.io/article/3687)

## 一些理论

### 可用性与一致性

#### CAP 理论

在一个分布式计算系统中，只能同时满足下列的两点:

- **一致性** ─ 每次访问都能获得最新数据但可能会收到错误响应
- **可用性** ─ 每次访问都能收到非错响应，但不保证获取到最新数据
- **分区容错性** ─ 在任意分区网络故障的情况下系统仍能继续运行

**网络并不可靠，所以你应要支持分区容错性，并需要在软件可用性和一致性间做出取舍。**

#### 一致性模式

同一份数据有多份副本，怎样同步才能让客户端有一致的数据。

[通俗易懂 强一致性、弱一致性、最终一致性、读写一致性、单调读、因果一致性 的区别与联系](https://zhuanlan.zhihu.com/p/67949045)

## 主要模块

### 负载均衡

#### DNS

优点：

- 使用简单：负载均衡工作，交给DNS服务器处理，省掉了负载均衡服务器维护的麻烦
- 提高性能：可以支持基于地址的域名解析，解析成距离用户最近的服务器地址，可以加快访问速度，改善性能；

缺点：

- 可用性差：DNS解析是多级解析，新增/修改DNS后，解析时间较长；解析过程中，用户访问网站将失败；
- 扩展性低：DNS负载均衡的控制权在域名商那里，无法对其做更多的改善和扩展；
- 维护性差：也不能反映服务器的当前运行状态；支持的算法少；不能区分服务器的差异（不能根据系统与服务的状态来判断负载）

#### 反向代理

![picture 20](http://qiniu.houserqu.com/c4eee172d49f9efaf78f587713075fcb2f29a48354d1ef65445aa0894c58b015.png)  

所有请求先经过 Nginx （网关），在代理到不同的机器上，存在网关服务器扛不住而崩溃的情况

#### 数据链路返回

![picture 21](http://qiniu.houserqu.com/b522aa377d1d5e2579a90e87fff355d5194b20e7675586b2db20852222d4deec.png)  

这种方式，通过给应用服务器设置虚拟IP，然后通过修改mac地址的方式，将请求分发出去，而应用服务器 收到请求后，可以直接响应给客户端。

好处是网关服务器只需要接受请求，不需要他来响应，由应用服务器自己去响应，降低网关压力

#### 混合模式

![picture 22](http://qiniu.houserqu.com/0b7c9faf764b3dc06547803ee246fb48b0576434d883e1f585fc29ac328bac01.png)  

![picture 23](http://qiniu.houserqu.com/ef8a6760a341b9dd9bbb7783eaa9699cd23c1040b0ed781f52cdb51fc7a425c6.png)  

#### NGINX

##### 负载均衡算法

###### 轮询

将所有请求，依次分发到每台服务器上，适合服务器硬件同相同的场景。
优点：服务器请求数目相同；
缺点：服务器压力不一样，不适合服务器配置不同的情况；

###### 随机

请求随机分配到各个服务器。
优点：使用简单；
缺点：不适合机器配置不同的场景；

###### 最少链接

将请求分配到连接数最少的服务器（目前处理请求最少的服务器）。
优点：根据服务器当前的请求处理情况，动态分配；
缺点：算法实现相对复杂，需要监控服务器请求连接数；

###### Hash（源地址散列）

根据IP地址进行Hash计算，得到IP地址。
优点：将来自同一IP地址的请求，同一会话期内，转发到相同的服务器；实现会话粘滞。
缺点：目标服务器宕机后，会话会丢失；

###### 加权

在轮询，随机，最少链接，Hash’等算法的基础上，通过加权的方式，进行负载服务器分配。
优点：根据权重，调节转发服务器的请求数目；
缺点：使用相对复杂

### 数据库

#### 关系数据库（SQL）

选取 **SQL** 的原因:

- 结构化数据
- 严格的模式
- 关系型数据
- 需要复杂的联结操作
- 事务
- 清晰的扩展模式
- 既有资源更丰富：开发者、社区、代码库、工具等
- 通过索引进行查询非常快

**事务**

**ACID** 用来描述关系型数据库[事务](https://en.wikipedia.org/wiki/Database_transaction)的特性。

- **原子性** - 每个事务内部所有操作要么全部完成，要么全部不完成。
- **一致性** - 任何事务都使数据库从一个有效的状态转换到另一个有效状态。
- **隔离性** - 并发执行事务的结果与顺序执行事务的结果相同。
- **持久性** - 事务提交后，对系统的影响是永久的。

#### NoSql

选取 **NoSQL** 的原因：

- 半结构化数据
- 动态或灵活的模式
- 非关系型数据
- 不需要复杂的联结操作
- 存储 TB （甚至 PB）级别的数据
- 高数据密集的工作负载
- IOPS 高吞吐量

适合 NoSQL 的示例数据：

- 埋点数据和日志数据
- 排行榜或者得分数据
- 临时数据，如购物车
- 频繁访问的（“热”）表
- 元数据／查找表

#### 图数据库

在图数据库中，一个节点对应一条记录，一个弧对应两个节点之间的关系。图数据库被优化用于表示外键繁多的复杂关系或多对多关系，如社交网络，提供了很高的性能。

### 缓存

#### 缓存类型

| 类型           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| 客户端缓存     | 操作系统或者浏览器等客户端本地进行缓存                       |
| CDN 缓存       | 在离用户最近的网络节点上进行缓存                             |
| Web 服务器缓存 | Nginx 等服务可以将静态或动态内容进行缓存，不每次去请求应用服务器 |
| 数据库缓存     | 数据库的默认配置中通常包含缓存级别                           |
| 应用缓存       | 应用程序使用 Memcached、Redis 等程序将数据缓存在内存中，而不是每次从磁盘读取 |

